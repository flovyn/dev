name: Workspace Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0)'
        required: true
      dry_run:
        description: 'Dry run (no actual releases)'
        type: boolean
        default: true

jobs:
  release-sdk-rust:
    name: Release sdk-rust
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sdk-rust
        uses: actions/checkout@v4
        with:
          repository: flovyn/sdk-rust
          token: ${{ secrets.WORKSPACE_PAT }}

      - name: Verify version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 0.2.0)"
            exit 1
          fi

      - name: Check if tag exists
        run: |
          if git ls-remote --exit-code --tags origin "refs/tags/v${{ inputs.version }}" 2>/dev/null; then
            echo "Error: Tag v${{ inputs.version }} already exists in sdk-rust"
            exit 1
          fi

      - name: Create and push tag
        if: ${{ !inputs.dry_run }}
        run: |
          git tag "v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"
        # This triggers sdk-rust's release workflow

      - name: Dry run - would create tag
        if: ${{ inputs.dry_run }}
        run: |
          echo "DRY RUN: Would create and push tag v${{ inputs.version }}"

  wait-sdk-rust-release:
    name: Wait for sdk-rust Release
    runs-on: ubuntu-latest
    needs: release-sdk-rust
    if: ${{ !inputs.dry_run }}
    timeout-minutes: 30
    steps:
      - name: Wait for sdk-rust release workflow to complete
        env:
          GH_TOKEN: ${{ secrets.WORKSPACE_PAT }}
        run: |
          TAG="v${{ inputs.version }}"
          echo "Waiting for sdk-rust release workflow (tag: $TAG)..."

          # Wait for the workflow run to appear (triggered by tag push)
          for i in $(seq 1 72); do
            RUN_ID=$(gh run list -R flovyn/sdk-rust -w Release \
              --json databaseId,headBranch,status \
              --jq ".[] | select(.headBranch == \"$TAG\") | .databaseId" \
              | head -1)
            if [ -n "$RUN_ID" ]; then
              echo "Found workflow run: $RUN_ID"
              break
            fi
            echo "Waiting for workflow run to appear... ($i/72)"
            sleep 10
          done

          if [ -z "$RUN_ID" ]; then
            echo "Error: sdk-rust release workflow not found after 12 minutes"
            exit 1
          fi

          # Wait for it to complete
          echo "Waiting for run $RUN_ID to complete..."
          gh run watch "$RUN_ID" -R flovyn/sdk-rust --exit-status

      - name: Verify GitHub Release exists
        env:
          GH_TOKEN: ${{ secrets.WORKSPACE_PAT }}
        run: |
          TAG="v${{ inputs.version }}"
          gh release view "$TAG" -R flovyn/sdk-rust --json tagName
          echo "sdk-rust release $TAG is available"

  release-language-sdks:
    name: Release Language SDKs
    runs-on: ubuntu-latest
    needs: [release-sdk-rust, wait-sdk-rust-release]
    if: ${{ always() && needs.release-sdk-rust.result == 'success' && (inputs.dry_run || needs.wait-sdk-rust-release.result == 'success') }}
    strategy:
      matrix:
        repo: [sdk-python, sdk-kotlin, sdk-typescript]
    steps:
      - name: Checkout ${{ matrix.repo }}
        uses: actions/checkout@v4
        with:
          repository: flovyn/${{ matrix.repo }}
          token: ${{ secrets.WORKSPACE_PAT }}

      - name: Check if tag exists
        run: |
          if git ls-remote --exit-code --tags origin "refs/tags/v${{ inputs.version }}" 2>/dev/null; then
            echo "Error: Tag v${{ inputs.version }} already exists in ${{ matrix.repo }}"
            exit 1
          fi

      - name: Determine version variable name
        id: vars
        run: |
          if [ "${{ matrix.repo }}" = "sdk-typescript" ]; then
            echo "var_name=NAPI_VERSION" >> $GITHUB_OUTPUT
          else
            echo "var_name=FFI_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Update FFI/NAPI version in CI workflow
        run: |
          VAR_NAME="${{ steps.vars.outputs.var_name }}"
          sed -i "s/${VAR_NAME}: v.*/${VAR_NAME}: v${{ inputs.version }}/" .github/workflows/ci.yml
          if git diff --quiet .github/workflows/ci.yml; then
            echo "No changes needed - version already set"
          else
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add .github/workflows/ci.yml
            git commit -m "chore: update FFI/NAPI version to v${{ inputs.version }}"
            echo "VERSION_UPDATED=true" >> $GITHUB_ENV
          fi

      - name: Push version update
        if: ${{ !inputs.dry_run && env.VERSION_UPDATED == 'true' }}
        run: git push

      - name: Create and push tag
        if: ${{ !inputs.dry_run }}
        run: |
          git tag "v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

      - name: Dry run - would update and tag
        if: ${{ inputs.dry_run }}
        run: |
          echo "DRY RUN: Would update ${{ steps.vars.outputs.var_name }} to v${{ inputs.version }}"
          echo "DRY RUN: Would create and push tag v${{ inputs.version }}"
          if [ "${{ env.VERSION_UPDATED }}" = "true" ]; then
            echo "Changes that would be committed:"
            git diff HEAD~1 .github/workflows/ci.yml || git diff .github/workflows/ci.yml
          fi

  release-server:
    name: Release flovyn-server
    runs-on: ubuntu-latest
    needs: release-language-sdks
    steps:
      - name: Checkout flovyn-server
        uses: actions/checkout@v4
        with:
          repository: flovyn/flovyn-server
          token: ${{ secrets.WORKSPACE_PAT }}

      - name: Check if tag exists
        run: |
          if git ls-remote --exit-code --tags origin "refs/tags/v${{ inputs.version }}" 2>/dev/null; then
            echo "Error: Tag v${{ inputs.version }} already exists in flovyn-server"
            exit 1
          fi

      - name: Create and push tag
        if: ${{ !inputs.dry_run }}
        run: |
          git tag "v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

      - name: Dry run - would create tag
        if: ${{ inputs.dry_run }}
        run: |
          echo "DRY RUN: Would create and push tag v${{ inputs.version }}"

  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [release-sdk-rust, wait-sdk-rust-release, release-language-sdks, release-server]
    if: always()
    steps:
      - name: Print release summary
        run: |
          echo "=== Workspace Release Summary ==="
          echo "Version: v${{ inputs.version }}"
          echo "Dry run: ${{ inputs.dry_run }}"
          echo ""
          echo "Release order:"
          echo "1. sdk-rust: ${{ needs.release-sdk-rust.result }}"
          echo "2. sdk-python, sdk-kotlin, sdk-typescript: ${{ needs.release-language-sdks.result }}"
          echo "3. flovyn-server: ${{ needs.release-server.result }}"
          echo ""
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "This was a DRY RUN - no tags were created"
          else
            echo "Tags created:"
            echo "  - flovyn/sdk-rust: v${{ inputs.version }}"
            echo "  - flovyn/sdk-python: v${{ inputs.version }}"
            echo "  - flovyn/sdk-kotlin: v${{ inputs.version }}"
            echo "  - flovyn/sdk-typescript: v${{ inputs.version }}"
            echo "  - flovyn/flovyn-server: v${{ inputs.version }}"
          fi
