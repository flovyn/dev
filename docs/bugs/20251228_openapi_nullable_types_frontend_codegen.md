# Bug Report: OpenAPI 3.1 Nullable Types Break Frontend Code Generation

**Date:** 2025-12-28
**Severity:** Medium
**Component:** OpenAPI Spec Generation (utoipa)
**Affects:** Frontend TypeScript code generation

## Summary

The OpenAPI spec generated by utoipa uses OpenAPI 3.1 nullable type syntax (`type: ["string", "null"]`) which is not supported by the frontend's `@openapi-codegen/typescript` library, causing it to generate `void` instead of proper nullable types like `string | null`.

## Problem

### Current OpenAPI Output (3.1 style)

```json
"description": {
  "type": ["string", "null"],
  "description": "Description of the task"
}
```

### Generated TypeScript (broken)

```typescript
description?: void;  // Should be: description?: string | null;
```

### Impact

This affects ~30+ fields across the API, causing TypeScript compilation errors in the frontend:

```
error TS2322: Type 'void | undefined' is not assignable to type 'ReactNode'.
error TS2322: Type 'string' is not assignable to type 'void'.
```

## Affected Fields

### String nullable fields
- `description` - on TaskDefinitionResponse, WorkflowDefinitionResponse, capabilities
- `error` - on TaskResponse, TaskExecutionSummary, TaskAttemptResponse
- `progressDetails` - on TaskResponse, TaskExecutionSummary
- `hostName`, `processId`, `workerVersion` - on WorkerResponse
- `workerId` - on TaskResponse, TaskAttemptResponse
- `note` - in RetryWorkflowRequest

### Number nullable fields
- `progress` - on TaskResponse
- `timeoutSeconds` - on TaskDefinitionResponse
- `total` - on list responses

### Timestamp nullable fields
- `completedAt`, `startedAt`, `scheduledAt`, `finishedAt`, `lastRegisteredAt`

### Object/JSON nullable fields
- `input`, `output` - on TaskResponse
- `inputSchema`, `outputSchema` - on TaskDefinitionResponse
- `metadata` - various

### Query parameter fields
- `status` - in ListTasksQueryParams, ListWorkflowsQueryParams

## Root Cause

OpenAPI 3.1 introduced a breaking change for nullable types:

| Version | Nullable Syntax |
|---------|-----------------|
| 3.0 | `type: "string"` + `nullable: true` |
| 3.1 | `type: ["string", "null"]` (JSON Schema style) |

The `@openapi-codegen/typescript` library (v11.1.0) doesn't support OpenAPI 3.1's nullable syntax. This is a [known issue](https://github.com/fabien0102/openapi-codegen/issues/175) that hasn't been fixed.

## Investigation Findings

### utoipa Does NOT Support OpenAPI 3.0

The utoipa maintainer explicitly decided **not to support** older OpenAPI versions:

- [GitHub Issue #1130](https://github.com/juhaku/utoipa/issues/1130) was closed (Oct 2024)
- Maintainer stated: "there is no big plans for supporting older OpenAPI spec versions"
- No configuration option exists to switch between 3.0 and 3.1 output

This rules out Options 1 and 2 from the original proposal.

## Proposed Solutions

### Option 1: Post-process with OpenAPI Downgrade Tool (Recommended)

Use a dedicated tool to convert OpenAPI 3.1 → 3.0 before frontend code generation.

**Available tools:**

| Tool | Language | Notes |
|------|----------|-------|
| [@apiture/openapi-down-convert](https://www.npmjs.com/package/@apiture/openapi-down-convert) | Node.js | Lightweight, easy npm integration |
| [openapi-downgrade](https://pypi.org/project/openapi-downgrade/) | Python | More comprehensive, built for FastAPI + Azure APIM |

Both tools convert `type: ["string", "null"]` → `type: "string", nullable: true`.

**Updated frontend workflow:**
```
export-openapi → openapi-down-convert → @openapi-codegen/typescript
```

### Option 2: Switch Frontend Code Generator

Use a TypeScript code generator that supports OpenAPI 3.1:

- [orval](https://orval.dev) - Full OpenAPI 3.1 support
- [openapi-typescript](https://github.com/drwpow/openapi-typescript) - Generates types from 3.1 specs

### Option 3: Keep Current Workaround (Not Recommended)

Continue using the `sed` script in `post-generate.sh`. This is fragile and requires manual updates when new nullable fields are added.

## Current Workaround

The frontend has a post-processing script (`flovyn-server/packages/api/scripts/post-generate.sh`) that patches the generated TypeScript to replace `void` with proper types:

```bash
sed -i '' 's/description?: void;/description?: string | null;/g' "$SCHEMAS_FILE"
```

This is fragile and requires manual updates when new nullable fields are added.

## Recommendation

**Use Option 1: @apiture/openapi-down-convert** (Node.js)

Rationale:
- Integrates naturally with existing npm/pnpm workflow in flovyn-app
- Minimal changes required - just add one step to the generation script
- Robust conversion that handles all nullable patterns
- No need to migrate to a different code generator

Implementation:
```bash
# In flovyn-app/packages/api
pnpm add -D @apiture/openapi-down-convert

# Update generate script to:
# 1. Fetch OpenAPI spec from server
# 2. Run openapi-down-convert to produce 3.0 spec
# 3. Run @openapi-codegen/typescript on 3.0 spec
```

## References

- [fabien0102/openapi-codegen Issue #175](https://github.com/fabien0102/openapi-codegen/issues/175) - "Support for nullable types in OAS 3.1"
- [utoipa Issue #1130](https://github.com/juhaku/utoipa/issues/1130) - "Support for older OpenAPI spec versions" (closed)
- [OpenAPI 3.1 Spec - Schema Object](https://spec.openapis.org/oas/v3.1.0#schema-object)
- [utoipa GitHub](https://github.com/juhaku/utoipa)
- [@apiture/openapi-down-convert](https://www.npmjs.com/package/@apiture/openapi-down-convert)
- [openapi-downgrade (Python)](https://pypi.org/project/openapi-downgrade/)

## Verification

After fixing, regenerate the frontend types and verify:

```bash
# In flovyn-app
cd packages/api
pnpm generate

# Check types
cd ../../apps/web
pnpm check-types
```

Expected: 0 TypeScript errors related to `void` types.
