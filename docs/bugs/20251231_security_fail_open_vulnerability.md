# Bug: Security Fail-Open Vulnerability

**Date**: 2025-12-31
**Severity**: Critical (Security)
**Component**: Auth Builder
**Status**: Fixed

## Summary

When configured authenticators fail to initialize (missing feature, missing DB pool, etc.), the auth builder silently falls back to `NoOpAuthenticator`, allowing **all requests without authentication**. This is a fail-open vulnerability.

## Reproduction

1. Configure server with `server-saas.toml`:
   ```toml
   [auth.endpoints.http]
   authenticators = ["better_auth_jwt", "better_auth_api_key"]
   ```

2. Start server (these authenticators may fail to init if better-auth feature disabled or DB pool not passed)

3. Make unauthenticated request:
   ```bash
   curl http://localhost:8000/api/orgs/dev/workflow-executions/...
   ```

4. **Result**: Request succeeds with 200 OK (should be 401 Unauthorized)

## Root Cause

In `flovyn-server/server/src/auth/builder.rs` lines 317-318:

```rust
if authenticators.is_empty() {
    Arc::new(NoOpAuthenticator)  // DANGER: Allows all requests!
}
```

When authenticators are skipped due to:
- Missing `better-auth` feature (lines 267-272, 301-306)
- Missing database pool (lines 263-265, 296-298)
- Invalid configuration (lines 278-281)

The `authenticators` vector ends up empty, and `NoOpAuthenticator` is returned.

## Impact

- **Complete authentication bypass** when authenticators fail to initialize
- Silent failure - no error, just warnings in logs that are easy to miss
- Any HTTP/gRPC request can access any org's data without credentials
- Affects both HTTP and gRPC endpoints

## Proposed Fix

Change fail-open to fail-closed behavior:

```rust
// Option 1: Return error instead of NoOp
if authenticators.is_empty() {
    tracing::error!(
        "No authenticators could be initialized for endpoint. \
         This is a security issue - refusing to start."
    );
    panic!("Security configuration error: no authenticators available");
}

// Option 2: Return an authenticator that always denies
if authenticators.is_empty() {
    Arc::new(DenyAllAuthenticator)  // New type that always returns Unauthorized
}
```

## Files to Modify

- `flovyn-server/server/src/auth/builder.rs` - Change fallback behavior at line 317-318
- Add `DenyAllAuthenticator` type or panic on misconfiguration
- Add integration test to verify fail-closed behavior

## Verification

After fix, this should return 401:
```bash
# With no auth
curl -v http://localhost:8000/api/orgs/dev/workflow-executions/...

# With invalid auth
curl -v -H "Authorization: Bearer invalid" http://localhost:8000/api/orgs/dev/...
```

## Logs to Check

The server logs show warnings when authenticators are skipped:
```
WARN better_auth_jwt authenticator requires better-auth feature, skipping
WARN better_auth_api_key authenticator requires better-auth feature, skipping
```

These warnings should be ERRORS and the server should refuse to start.

---

## Fix Applied

**Fixed On**: 2025-12-31

### Changes Made

1. **Created `DenyAllAuthenticator`** (`flovyn-server/server/src/auth/authenticator/deny_all.rs`):
   - New authenticator type that always rejects requests with an error
   - Returns `AuthError::InvalidCredentials` with a reason explaining why auth is unavailable
   - Used as fail-closed fallback when configured authenticators fail to initialize

2. **Updated `AuthStackBuilder::build_authenticator`** (`flovyn-server/server/src/auth/builder.rs`):
   - Changed log levels from `warn!` to `error!` when authenticators are skipped
   - Tracks which authenticators were skipped and their reasons
   - When all configured authenticators fail, uses `DenyAllAuthenticator` instead of `NoOpAuthenticator`
   - Logs a SECURITY error message when falling back to deny-all

3. **Added Tests**:
   - `test_builder_unknown_authenticator_uses_deny_all` - verifies deny_all is used for unknown auth
   - `test_builder_unknown_authenticator_rejects_all_requests` - verifies requests are rejected
   - `test_builder_all_configured_authenticators_fail_uses_deny_all` - verifies multiple failures use deny_all
   - `test_builder_empty_authenticators_uses_noop` - verifies empty config (intentional disable) still uses noop
   - `test_builder_mixed_valid_invalid_authenticators_uses_valid` - verifies partial success uses valid auth
   - `test_deny_all_error_message_includes_reason` - verifies error messages are informative

### Behavior After Fix

| Scenario | Before (Vulnerable) | After (Fixed) |
|----------|---------------------|---------------|
| No authenticators configured (`[]`) | NoOp (allow all) | NoOp (allow all) - intentional |
| All configured authenticators fail | NoOp (allow all) | **DenyAll (reject all)** |
| Some authenticators fail, some succeed | Use successful ones | Use successful ones |
| Unknown authenticator | NoOp (allow all) | **DenyAll (reject all)** |

### Test Results

```
test auth::builder::tests::test_builder_unknown_authenticator_uses_deny_all ... ok
test auth::builder::tests::test_builder_unknown_authenticator_rejects_all_requests ... ok
test auth::builder::tests::test_builder_all_configured_authenticators_fail_uses_deny_all ... ok
test auth::builder::tests::test_builder_empty_authenticators_uses_noop ... ok
test auth::builder::tests::test_builder_mixed_valid_invalid_authenticators_uses_valid ... ok
test auth::builder::tests::test_deny_all_error_message_includes_reason ... ok
```

### Integration Test Fixes

The security fix exposed that some integration tests were relying on the fail-open behavior
(tests that didn't send API key headers were passing because auth was silently bypassed).

**Added to `harness.rs`**:
- `http_client()` - Returns a reqwest client with API key authorization header pre-configured
- `auth_header()` - Returns the authorization header value for manual requests

**Fixed streaming tests** to use `harness.http_client()` instead of `reqwest::Client::new()`:

```
test streaming_tests::test_sse_endpoint_exists ... ok
test streaming_tests::test_sse_endpoint_invalid_workflow_id ... ok
test streaming_tests::test_sse_endpoint_workflow_not_found ... ok
```
