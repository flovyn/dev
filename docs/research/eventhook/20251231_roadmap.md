# Eventhook Roadmap

## Vision

Eventhook is Flovyn's unified event routing system - a single plugin that handles:
- **Inbound webhooks** from external providers (GitHub, Stripe, etc.)
- **Internal events** from workflow/task lifecycle
- **Event routing** to workflows, tasks, and promises based on rules
- **Outbound delivery** to external systems

Think: AWS EventBridge meets webhook gateway, built into Flovyn.

---

## Milestones

### Milestone 0: Foundation
**Goal:** Core changes to enable event-driven architecture

| Task | Status | Description |
|------|--------|-------------|
| Unified EventPublisher | TODO | Rename `StreamEventPublisher` → `EventPublisher`, add `Event` trait |

**Note:** Path-specific auth is NOT a core prerequisite. Plugin routes are merged without the core auth middleware (see `server/src/api/rest/mod.rs:202-203`), so the Eventhook plugin handles its own authentication:
- **Ingest routes** (`/in/{source}`): Signature verification in handler/middleware
- **Management routes** (`/sources`, `/rules`): Apply org auth middleware if needed

**Existing infrastructure to leverage:**
- `StreamEventPublisher` (`server/src/streaming/`) - Already publishes lifecycle events (WORKFLOW_STARTED, TASK_COMPLETED) for SSE streaming
- `TaskStreamEvent` with `StateEventPayload` - Contains workflow/task snapshots
- In-memory and NATS backends exist

**Unified approach (from research.md section 24.6.1):**
```
                     ┌─────────────────────┐
                     │   EventPublisher    │  ← Single trait
                     │   (unified)         │
                     └──────────┬──────────┘
                                │
                     ┌──────────▼──────────┐
                     │    NATS / Memory    │
                     └──────────┬──────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
  SSE Streaming          Rules Engine            Audit Log
  stream.{wf_id}.*       events.{org}.*       events.{org}.*
```

**Exit criteria:** Core is ready; no plugin code yet.

---

### Milestone 1: Receive & Route
**Goal:** Receive webhooks and route to workflows

| Task | Status | Description |
|------|--------|-------------|
| Plugin skeleton | TODO | Basic plugin structure, registration |
| Database schema | TODO | Sources, events, rules tables |
| WebhookSourceAuthenticator | TODO | Verify signatures (HMAC, API key) |
| Ingest endpoint | TODO | `POST /eventhook/in/{source}` |
| Event bus core | TODO | `FlovynEvent`, `EventRouter` trait |
| Built-in targets | TODO | WorkflowTarget, TaskTarget, PromiseTarget |
| Basic rule matching | TODO | Match on source + event type |

**Exit criteria:**
```bash
# This works:
curl -X POST /api/orgs/acme/eventhook/in/github \
  -H "X-Hub-Signature-256: sha256=..." \
  -d '{"action": "push", ...}'
# → Triggers workflow based on configured rule
```

---

### Milestone 2: Management API
**Goal:** Full CRUD for configuration

| Task | Status | Description |
|------|--------|-------------|
| Sources CRUD | TODO | Create, list, update, delete webhook sources |
| Rules CRUD | TODO | Create, list, update, delete routing rules |
| Events API | TODO | List events, view details, replay |
| Provider templates | TODO | Pre-configured verifiers for GitHub, Stripe, etc. |

**Exit criteria:** All configuration via REST API.

---

### Milestone 3: Advanced Routing
**Goal:** EventBridge-like pattern matching

| Task | Status | Description |
|------|--------|-------------|
| Data pattern matching | TODO | Match on JSON fields in event data |
| Input transformation | TODO | JMESPath extraction |
| JavaScript transform | TODO | Custom transforms via QuickJS |
| Filter functions | TODO | JavaScript predicates |
| Multi-target rules | TODO | One event → multiple targets |

**Exit criteria:**
```yaml
# This rule works:
pattern:
  type: ["order.created"]
  data:
    total: [{ "numeric": [">=", 1000] }]
targets:
  - type: workflow
    config: { kind: "vip-handler" }
  - type: task
    config: { kind: "notify-sales" }
```

---

### Milestone 4: Outbound Delivery
**Goal:** Send events to external systems

| Task | Status | Description |
|------|--------|-------------|
| Endpoints CRUD | TODO | Manage outbound webhook endpoints |
| OutboundWebhookTarget | TODO | HTTP delivery with retry |
| Signature generation | TODO | Sign outbound requests (Svix-compatible) |
| Delivery tracking | TODO | Log attempts, status, retries |

**Exit criteria:**
```yaml
# Events can be delivered externally:
targets:
  - type: webhook
    config:
      endpoint: "analytics-service"
      # → POST to configured URL with signature
```

---

### Milestone 5: Scale (Future)
**Goal:** Production-grade scalability

| Task | Status | Description |
|------|--------|-------------|
| JetStream integration | TODO | Durable event stream |
| Consumer-based processing | TODO | Horizontal scaling |
| Dead letter queue | TODO | Handle failed events |
| Stream replay | TODO | Replay from any point in time |

---

## Quick Reference

| Component | Location | Purpose |
|-----------|----------|---------|
| Research | `research.md` | Detailed design, data models, API specs |
| Roadmap | `roadmap.md` | This file - high-level milestones |

## Dependencies

```
Milestone 0 (Foundation)
    ↓
Milestone 1 (Receive & Route) ←── Core functionality
    ↓
Milestone 2 (Management API)
    ↓
Milestone 3 (Advanced Routing)
    ↓
Milestone 4 (Outbound Delivery)
    ↓
Milestone 5 (Scale) ←── Future/optional
```
