# Flovyn Full Stack Development Environment
# Usage:
#   Start: ./dev.sh start
#   Stop:  ./dev.sh stop
#   Logs:  docker compose logs -f [service]

services:
  # PostgreSQL for Flovyn Server
  postgres-server:
    image: postgres:18-alpine
    container_name: flovyn-postgres-server
    environment:
      POSTGRES_USER: flovyn
      POSTGRES_PASSWORD: flovyn
      POSTGRES_DB: flovyn
    ports:
      - "${SERVER_POSTGRES_PORT:-5435}:5432"
    volumes:
      - postgres-server-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U flovyn -d flovyn"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - flovyn

  # PostgreSQL for Flovyn App (Better Auth)
  postgres-app:
    image: postgres:18-alpine
    container_name: flovyn-postgres-app
    environment:
      POSTGRES_USER: flovyn-app
      POSTGRES_PASSWORD: flovyn-app
      POSTGRES_DB: flovyn-app
    ports:
      - "${APP_POSTGRES_PORT:-5433}:5432"
    volumes:
      - postgres-app-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U flovyn-app -d flovyn-app"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - flovyn

  # NATS Message Broker
  nats:
    image: nats:2.10-alpine
    container_name: flovyn-nats
    ports:
      - "${NATS_PORT:-4222}:4222"
      - "${NATS_MONITOR_PORT:-8222}:8222"
    command: ["--http_port", "8222", "-js"]
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - flovyn

  # Jaeger - Distributed Tracing with OTLP support
  jaeger:
    image: jaegertracing/all-in-one:1.54
    container_name: flovyn-jaeger
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    ports:
      - "${JAEGER_UI_PORT:-16686}:16686"
      - "${JAEGER_OTLP_GRPC_PORT:-4317}:4317"
      - "${JAEGER_OTLP_HTTP_PORT:-4318}:4318"
    networks:
      - flovyn

networks:
  flovyn:
    driver: bridge

volumes:
  postgres-server-data:
  postgres-app-data:
