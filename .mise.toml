# Flovyn Full Stack Development Environment
# Usage: mise run <task>

[tasks.start]
description = "Start infrastructure services"
run = "./dev.sh start {{arg(name='scenario', default='self-hosted')}}"

[tasks.stop]
description = "Stop infrastructure services"
run = "./dev.sh stop"

[tasks.server]
description = "Start flovyn-server (run setup-self-hosted or setup-saas first)"
run = """
if ! docker ps --format '{% raw %}{{.Names}}{% endraw %}' | grep -q flovyn-postgres-server; then
  echo "Error: Infrastructure not running. Run 'mise run setup-self-hosted' or 'mise run setup-saas' first."
  exit 1
fi
./dev.sh server {{arg(name='scenario', default='self-hosted')}}
"""

[tasks.app]
description = "Start flovyn-app (run setup-self-hosted or setup-saas first)"
run = """
if ! docker ps --format '{% raw %}{{.Names}}{% endraw %}' | grep -q flovyn-postgres-app; then
  echo "Error: Infrastructure not running. Run 'mise run setup-self-hosted' or 'mise run setup-saas' first."
  exit 1
fi
./dev.sh app
"""

[tasks.status]
description = "Show service status"
run = "./dev.sh status"

[tasks.logs]
description = "Show logs (optionally for a specific service)"
run = "./dev.sh logs {{arg(name='service', default='')}}"

[tasks.migrate]
description = "Run all database migrations"
run = "./dev.sh migrate"

[tasks.clean]
description = "Remove all containers and data"
run = "./dev.sh clean"

[tasks.setup-self-hosted]
description = "Full setup for self-hosted development"
depends = ["start", "migrate"]
run = """
echo ""
echo "Setup complete! Run 'mise run server' and 'mise run app' in separate terminals."
"""

[tasks.setup-saas]
description = "Full setup for SaaS development"
run = """
./dev.sh start saas
./dev.sh migrate
echo ""
echo "Setup complete! Run 'mise run server saas' and 'mise run app' in separate terminals."
"""

[tasks.db-server]
description = "Connect to server database (interactive)"
run = "docker exec -it flovyn-postgres-server psql -U flovyn -d flovyn"

[tasks.db-app]
description = "Connect to app database (interactive)"
run = "docker exec -it flovyn-postgres-app psql -U flovyn-app -d flovyn-app"

[tasks.query-server]
description = "Query server database"
run = "docker exec flovyn-postgres-server psql -U flovyn -d flovyn -c \"{{arg(name='sql')}}\""

[tasks.query-app]
description = "Query app database"
run = "docker exec flovyn-postgres-app psql -U flovyn-app -d flovyn-app -c \"{{arg(name='sql')}}\""

[tasks.jaeger]
description = "Open Jaeger UI"
run = "open http://localhost:16686"

[tasks.open-app]
description = "Open Flovyn App"
run = "open http://localhost:3000"

[tasks.open-docs]
description = "Open API docs"
run = "open http://localhost:8000/api/docs"

# SDK Examples (Rust)
# Loads .env from dev directory automatically via DOTENV_PATH
[tasks."example:hello"]
description = "Run hello-world example worker"
dir = "../sdk-rust"
run = "cargo run -p hello-world-sample"
env = { DOTENV_PATH = "../dev/.env" }

[tasks."example:ecommerce"]
description = "Run ecommerce example worker"
dir = "../sdk-rust"
run = "cargo run -p ecommerce-sample"
env = { DOTENV_PATH = "../dev/.env" }

[tasks."example:pipeline"]
description = "Run data-pipeline example worker"
dir = "../sdk-rust"
run = "cargo run -p data-pipeline-sample"
env = { DOTENV_PATH = "../dev/.env" }

[tasks."example:patterns"]
description = "Run patterns example worker"
dir = "../sdk-rust"
run = "cargo run -p patterns-sample"
env = { DOTENV_PATH = "../dev/.env" }

[tasks."example:standalone"]
description = "Run standalone-tasks example worker"
dir = "../sdk-rust"
run = "cargo run -p standalone-tasks-sample"
env = { DOTENV_PATH = "../dev/.env" }

[tasks.agent-worker]
description = "Run agent-worker"
dir = "../agent-worker"
run = "DOTENV_PATH=../dev/.env cargo run"

# Remote access via Tailscale
[tasks."app:remote"]
description = "Start flovyn-app accessible via Tailscale (uses TS_HOSTNAME env var)"
run = """
if [ -z "$TS_HOSTNAME" ]; then
  # Try to auto-detect Tailscale hostname (remove trailing dot from FQDN)
  TS_HOSTNAME=$(tailscale status --json 2>/dev/null | jq -r '.Self.DNSName | rtrimstr(".")' || echo "")
fi
if [ -z "$TS_HOSTNAME" ]; then
  echo "Error: TS_HOSTNAME not set and could not auto-detect."
  echo "Set it manually: TS_HOSTNAME=your-host.ts.net mise run app:remote"
  exit 1
fi
echo "Using Tailscale hostname: $TS_HOSTNAME"
# BETTER_AUTH_TRUST_HOST allows auth from any origin (needed for Tailscale/remote access)
APP_URL="https://$TS_HOSTNAME" BETTER_AUTH_TRUST_HOST=true ./dev.sh app
"""

[tasks."server:remote"]
description = "Start flovyn-server with Tailscale OIDC URLs (uses TS_HOSTNAME env var)"
run = """
if [ -z "$TS_HOSTNAME" ]; then
  # Try to auto-detect Tailscale hostname (remove trailing dot from FQDN)
  TS_HOSTNAME=$(tailscale status --json 2>/dev/null | jq -r '.Self.DNSName | rtrimstr(".")' || echo "")
fi
if [ -z "$TS_HOSTNAME" ]; then
  echo "Error: TS_HOSTNAME not set and could not auto-detect."
  echo "Set it manually: TS_HOSTNAME=your-host.ts.net mise run server:remote"
  exit 1
fi
echo "Using Tailscale hostname: $TS_HOSTNAME"
APP_URL="https://$TS_HOSTNAME" ./dev.sh server {{arg(name='scenario', default='self-hosted')}}
"""
